<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>SRH Tutor â€” SPLA031</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
  :root {
    --rose:    #c0394b;
    --rose-lt: #e8536a;
    --rose-dk: #8f1f2e;
    --cream:   #fdf6f0;
    --sand:    #f0e6d8;
    --sand-dk: #d4c4b0;
    --ink:     #1a1218;
    --ink-lt:  #4a3a42;
    --muted:   #8a7a82;
    --white:   #ffffff;
    --radius:  16px;
    --shadow:  0 8px 32px rgba(26,18,24,0.12);
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€ Background pattern â”€â”€ */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 20% -10%, rgba(192,57,75,0.08) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 90% 100%, rgba(192,57,75,0.06) 0%, transparent 60%);
    pointer-events: none; z-index: 0;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #auth-screen {
    position: relative; z-index: 1;
    min-height: 100vh;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 24px 20px;
  }

  .brand {
    text-align: center; margin-bottom: 36px;
  }
  .brand-icon {
    width: 64px; height: 64px;
    background: linear-gradient(135deg, var(--rose), var(--rose-dk));
    border-radius: 20px;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 16px;
    box-shadow: 0 12px 28px rgba(192,57,75,0.35);
    font-size: 28px;
  }
  .brand h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem; color: var(--ink);
    letter-spacing: -0.5px;
  }
  .brand p {
    font-size: 0.85rem; color: var(--muted);
    font-weight: 300; margin-top: 4px;
  }

  .auth-card {
    background: var(--white);
    border-radius: var(--radius);
    padding: 32px 28px;
    width: 100%; max-width: 420px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(192,57,75,0.08);
  }

  .tab-switcher {
    display: flex; gap: 4px;
    background: var(--sand);
    border-radius: 12px; padding: 4px;
    margin-bottom: 28px;
  }
  .tab-btn {
    flex: 1; padding: 10px;
    border: none; background: transparent;
    border-radius: 9px; cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.875rem; font-weight: 500;
    color: var(--muted); transition: all 0.2s;
  }
  .tab-btn.active {
    background: var(--white);
    color: var(--rose);
    box-shadow: 0 2px 8px rgba(26,18,24,0.1);
  }

  .auth-form { display: flex; flex-direction: column; gap: 16px; }
  .auth-form.hidden { display: none; }

  .field { display: flex; flex-direction: column; gap: 6px; }
  .field label {
    font-size: 0.8rem; font-weight: 600;
    color: var(--ink-lt); letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .field input {
    padding: 13px 16px;
    border: 1.5px solid var(--sand-dk);
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem; color: var(--ink);
    background: var(--cream);
    outline: none; transition: border-color 0.2s;
    -webkit-appearance: none;
  }
  .field input:focus { border-color: var(--rose); background: var(--white); }
  .field input::placeholder { color: var(--sand-dk); }

  .btn-primary {
    padding: 15px;
    background: linear-gradient(135deg, var(--rose-lt), var(--rose-dk));
    color: var(--white);
    border: none; border-radius: 12px;
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem; font-weight: 600;
    cursor: pointer; margin-top: 4px;
    box-shadow: 0 6px 20px rgba(192,57,75,0.3);
    transition: all 0.2s; letter-spacing: 0.2px;
  }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(192,57,75,0.4); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

  .auth-error {
    background: #fef0f0; border: 1px solid #fca5a5;
    color: #b91c1c; border-radius: 10px;
    padding: 12px 14px; font-size: 0.875rem;
    display: none;
  }
  .auth-success {
    background: #f0fdf4; border: 1px solid #86efac;
    color: #166534; border-radius: 10px;
    padding: 12px 14px; font-size: 0.875rem;
    display: none;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHAT SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #chat-screen {
    display: none; flex-direction: column;
    height: 100vh; position: relative; z-index: 1;
  }

  /* Top bar */
  .topbar {
    background: var(--white);
    border-bottom: 1px solid var(--sand);
    padding: 14px 20px;
    display: flex; align-items: center; gap: 12px;
    position: sticky; top: 0; z-index: 10;
    box-shadow: 0 2px 12px rgba(26,18,24,0.06);
  }
  .topbar-icon {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--rose), var(--rose-dk));
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
  }
  .topbar-info { flex: 1; min-width: 0; }
  .topbar-info h2 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.05rem; color: var(--ink);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .topbar-info span {
    font-size: 0.75rem; color: var(--muted); font-weight: 400;
  }
  .topbar-actions { display: flex; gap: 8px; }
  .icon-btn {
    width: 36px; height: 36px;
    border: 1.5px solid var(--sand-dk);
    background: var(--cream);
    border-radius: 10px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; color: var(--muted);
    transition: all 0.18s;
  }
  .icon-btn:hover { border-color: var(--rose); color: var(--rose); background: var(--white); }

  /* Messages */
  #messages {
    flex: 1; overflow-y: auto;
    padding: 20px 16px;
    display: flex; flex-direction: column; gap: 16px;
    scroll-behavior: smooth;
  }

  /* Quick commands */
  .quick-commands {
    display: flex; gap: 8px; flex-wrap: wrap;
    padding: 0 16px 12px;
  }
  .quick-cmd {
    padding: 7px 14px;
    background: var(--white);
    border: 1.5px solid var(--sand-dk);
    border-radius: 20px; cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem; font-weight: 500; color: var(--ink-lt);
    transition: all 0.18s; white-space: nowrap;
  }
  .quick-cmd:hover { border-color: var(--rose); color: var(--rose); background: #fff5f6; }

  /* Bubbles */
  .bubble-wrap { display: flex; flex-direction: column; max-width: 84%; }
  .bubble-wrap.user { align-self: flex-end; align-items: flex-end; }
  .bubble-wrap.ai   { align-self: flex-start; align-items: flex-start; }

  .bubble {
    padding: 13px 16px;
    border-radius: 18px;
    font-size: 0.92rem; line-height: 1.6;
    word-break: break-word;
  }
  .bubble-wrap.user .bubble {
    background: linear-gradient(135deg, var(--rose-lt), var(--rose-dk));
    color: var(--white);
    border-bottom-right-radius: 4px;
  }
  .bubble-wrap.ai .bubble {
    background: var(--white);
    color: var(--ink);
    border: 1px solid var(--sand);
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 8px rgba(26,18,24,0.06);
  }
  .bubble-wrap.ai .bubble p { margin-bottom: 8px; }
  .bubble-wrap.ai .bubble p:last-child { margin-bottom: 0; }
  .bubble-wrap.ai .bubble strong { color: var(--rose-dk); }
  .bubble-wrap.ai .bubble code {
    background: var(--sand); padding: 2px 6px;
    border-radius: 5px; font-size: 0.85em;
  }
  .bubble-wrap.ai .bubble ul, .bubble-wrap.ai .bubble ol {
    padding-left: 18px; margin: 6px 0;
  }
  .bubble-wrap.ai .bubble li { margin-bottom: 4px; }

  .bubble-meta {
    font-size: 0.7rem; color: var(--muted);
    margin-top: 4px; padding: 0 4px;
  }

  .sources-tag {
    display: inline-flex; align-items: center; gap: 4px;
    background: #fff5f6; border: 1px solid rgba(192,57,75,0.2);
    color: var(--rose-dk);
    font-size: 0.72rem; font-weight: 500;
    padding: 3px 10px; border-radius: 20px;
    margin-top: 6px;
  }

  /* Typing indicator */
  .typing-bubble {
    background: var(--white);
    border: 1px solid var(--sand);
    border-radius: 18px; border-bottom-left-radius: 4px;
    padding: 14px 18px; display: flex; gap: 5px;
    box-shadow: 0 2px 8px rgba(26,18,24,0.06);
  }
  .dot {
    width: 7px; height: 7px;
    background: var(--sand-dk); border-radius: 50%;
    animation: bounce 1.2s infinite;
  }
  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-6px); background: var(--rose); }
  }

  /* Input area */
  .input-area {
    padding: 12px 16px 20px;
    background: var(--white);
    border-top: 1px solid var(--sand);
  }
  .input-row {
    display: flex; gap: 10px; align-items: flex-end;
  }
  #user-input {
    flex: 1;
    padding: 13px 16px;
    border: 1.5px solid var(--sand-dk);
    border-radius: 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem; color: var(--ink);
    background: var(--cream);
    outline: none; resize: none;
    max-height: 120px; min-height: 50px;
    transition: border-color 0.2s;
    -webkit-appearance: none;
  }
  #user-input:focus { border-color: var(--rose); background: var(--white); }
  #user-input::placeholder { color: var(--sand-dk); }

  .send-btn {
    width: 50px; height: 50px; flex-shrink: 0;
    background: linear-gradient(135deg, var(--rose-lt), var(--rose-dk));
    border: none; border-radius: 14px;
    color: var(--white); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 14px rgba(192,57,75,0.3);
    transition: all 0.18s;
  }
  .send-btn:hover { transform: scale(1.05); }
  .send-btn:active { transform: scale(0.97); }
  .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .send-btn svg { width: 20px; height: 20px; }

  /* Welcome card */
  .welcome-card {
    background: var(--white);
    border: 1px solid var(--sand);
    border-radius: var(--radius);
    padding: 24px; text-align: center;
    box-shadow: 0 4px 16px rgba(26,18,24,0.06);
    align-self: center; width: 100%;
    animation: fadeUp 0.4s ease both;
  }
  .welcome-card .wc-icon { font-size: 2.5rem; margin-bottom: 12px; }
  .welcome-card h3 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.25rem; color: var(--ink); margin-bottom: 8px;
  }
  .welcome-card p { font-size: 0.875rem; color: var(--muted); line-height: 1.6; }

  /* Animations */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .bubble-wrap { animation: fadeUp 0.3s ease both; }

  /* Toast */
  .toast {
    position: fixed; bottom: 90px; left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--ink); color: var(--white);
    padding: 10px 20px; border-radius: 100px;
    font-size: 0.85rem; opacity: 0;
    transition: all 0.3s; z-index: 999;
    white-space: nowrap;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Scrollbar */
  #messages::-webkit-scrollbar { width: 4px; }
  #messages::-webkit-scrollbar-track { background: transparent; }
  #messages::-webkit-scrollbar-thumb { background: var(--sand-dk); border-radius: 4px; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="brand">
    <div class="brand-icon">ğŸ¥</div>
    <h1>SRH Tutor</h1>
    <p>SPLA031 Â· Sexual &amp; Reproductive Health</p>
  </div>

  <div class="auth-card">
    <div class="tab-switcher">
      <button class="tab-btn active" onclick="switchTab('signin')">Sign In</button>
      <button class="tab-btn"        onclick="switchTab('signup')">Sign Up</button>
    </div>

    <!-- Sign In -->
    <form class="auth-form" id="signin-form" onsubmit="handleSignIn(event)">
      <div class="auth-error"  id="signin-error"></div>
      <div class="auth-success" id="signin-success"></div>
      <div class="field">
        <label>Email</label>
        <input type="email" id="signin-email" placeholder="your@email.com" required/>
      </div>
      <div class="field">
        <label>Password</label>
        <input type="password" id="signin-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required/>
      </div>
      <button type="submit" class="btn-primary" id="signin-btn">Sign In</button>
    </form>

    <!-- Sign Up -->
    <form class="auth-form hidden" id="signup-form" onsubmit="handleSignUp(event)">
      <div class="auth-error"   id="signup-error"></div>
      <div class="auth-success" id="signup-success"></div>
      <div class="field">
        <label>Full Name</label>
        <input type="text" id="signup-name" placeholder="Jane Doe" required/>
      </div>
      <div class="field">
        <label>Email</label>
        <input type="email" id="signup-email" placeholder="your@email.com" required/>
      </div>
      <div class="field">
        <label>Password</label>
        <input type="password" id="signup-password" placeholder="Min. 6 characters" minlength="6" required/>
      </div>
      <button type="submit" class="btn-primary" id="signup-btn">Create Account</button>
    </form>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHAT SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="chat-screen">
  <div class="topbar">
    <div class="topbar-icon">ğŸ¥</div>
    <div class="topbar-info">
      <h2>SRH Tutor</h2>
      <span id="user-label">Loadingâ€¦</span>
    </div>
    <div class="topbar-actions">
      <button class="icon-btn" onclick="clearHistory()" title="Clear chat">ğŸ—‘ï¸</button>
      <button class="icon-btn" onclick="signOut()" title="Sign out">ğŸšª</button>
    </div>
  </div>

  <div id="messages">
    <div class="welcome-card">
      <div class="wc-icon">ğŸ“–</div>
      <h3>Welcome to SPLA031</h3>
      <p>Ask me anything from your Sexual &amp; Reproductive Health training manual, or try a quick command below.</p>
    </div>
  </div>

  <div class="quick-commands">
    <button class="quick-cmd" onclick="quickSend('Explain the menstrual cycle')">ğŸ”¬ Menstrual cycle</button>
    <button class="quick-cmd" onclick="quickSend('What are the types of contraception?')">ğŸ’Š Contraception</button>
    <button class="quick-cmd" onclick="quickSend('Quiz me')">â“ Quiz me</button>
    <button class="quick-cmd" onclick="quickSend('Give me a case study exercise')">ğŸ“ Exercise</button>
    <button class="quick-cmd" onclick="quickSend('Explain HIV transmission')">ğŸ§¬ HIV</button>
  </div>

  <div class="input-area">
    <div class="input-row">
      <textarea id="user-input" placeholder="Ask about SRH topicsâ€¦" rows="1"
        onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <button class="send-btn" id="send-btn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = '';  // empty = same origin; or set to 'http://localhost:8000' for dev
let accessToken = localStorage.getItem('srh_token') || null;
let currentUser = null;

// â”€â”€ Tab switcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach((b,i) =>
    b.classList.toggle('active', (tab==='signin' && i===0)||(tab==='signup' && i===1))
  );
  document.getElementById('signin-form').classList.toggle('hidden', tab !== 'signin');
  document.getElementById('signup-form').classList.toggle('hidden', tab !== 'signup');
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleSignIn(e) {
  e.preventDefault();
  const btn = document.getElementById('signin-btn');
  const err = document.getElementById('signin-error');
  err.style.display = 'none';
  btn.disabled = true; btn.textContent = 'Signing inâ€¦';
  try {
    const res = await fetch(`${API}/auth/signin`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        email:    document.getElementById('signin-email').value,
        password: document.getElementById('signin-password').value
      })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || 'Sign in failed');
    accessToken = data.access_token;
    currentUser = data.user;
    localStorage.setItem('srh_token', accessToken);
    showChat();
  } catch(ex) {
    err.textContent = ex.message; err.style.display = 'block';
  } finally {
    btn.disabled = false; btn.textContent = 'Sign In';
  }
}

async function handleSignUp(e) {
  e.preventDefault();
  const btn = document.getElementById('signup-btn');
  const err = document.getElementById('signup-error');
  const suc = document.getElementById('signup-success');
  err.style.display = 'none'; suc.style.display = 'none';
  btn.disabled = true; btn.textContent = 'Creating accountâ€¦';
  try {
    const res = await fetch(`${API}/auth/signup`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        email:     document.getElementById('signup-email').value,
        password:  document.getElementById('signup-password').value,
        full_name: document.getElementById('signup-name').value
      })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || 'Sign up failed');
    suc.textContent = data.message || 'Account created! Please check your email.';
    suc.style.display = 'block';
    document.getElementById('signup-form').reset();
    setTimeout(() => switchTab('signin'), 2500);
  } catch(ex) {
    err.textContent = ex.message; err.style.display = 'block';
  } finally {
    btn.disabled = false; btn.textContent = 'Create Account';
  }
}

async function signOut() {
  try { await fetch(`${API}/auth/signout`, { method:'POST', headers: authHeaders() }); }
  catch(e) {}
  accessToken = null; currentUser = null;
  localStorage.removeItem('srh_token');
  document.getElementById('chat-screen').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('messages').innerHTML = `
    <div class="welcome-card">
      <div class="wc-icon">ğŸ“–</div>
      <h3>Welcome to SPLA031</h3>
      <p>Ask me anything from your Sexual &amp; Reproductive Health training manual.</p>
    </div>`;
  showToast('Signed out successfully');
}

function authHeaders() {
  return {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${accessToken}`
  };
}

// â”€â”€ Show chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showChat() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('chat-screen').style.display = 'flex';
  // Load user info
  try {
    if (!currentUser) {
      const r = await fetch(`${API}/auth/me`, { headers: authHeaders() });
      if (r.ok) currentUser = await r.json();
    }
    if (currentUser) {
      document.getElementById('user-label').textContent =
        currentUser.full_name || currentUser.email;
    }
    // Load history
    await loadHistory();
  } catch(e) {}
  document.getElementById('user-input').focus();
}

// â”€â”€ Load chat history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHistory() {
  try {
    const r = await fetch(`${API}/chat/history`, { headers: authHeaders() });
    if (!r.ok) return;
    const history = await r.json();
    if (history.length === 0) return;
    const container = document.getElementById('messages');
    container.innerHTML = '';
    history.forEach(msg => appendBubble(msg.role === 'human' ? 'user' : 'ai', msg.content, false));
    scrollBottom();
  } catch(e) {}
}

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendBubble(role, text, scroll=true) {
  const container = document.getElementById('messages');
  const wrap = document.createElement('div');
  wrap.className = `bubble-wrap ${role}`;
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  if (role === 'ai') {
    bubble.innerHTML = formatMarkdown(text);
  } else {
    bubble.textContent = text;
  }
  wrap.appendChild(bubble);
  container.appendChild(wrap);
  if (scroll) scrollBottom();
  return wrap;
}

function appendSources(parentWrap, sources) {
  if (!sources || sources.length === 0) return;
  const tag = document.createElement('div');
  tag.className = 'sources-tag';
  tag.innerHTML = `ğŸ“„ Manual pages: ${sources.join(', ')}`;
  parentWrap.appendChild(tag);
}

function formatMarkdown(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code>$1</code>')
    .replace(/^### (.+)$/gm, '<strong>$1</strong>')
    .replace(/^## (.+)$/gm, '<strong>$1</strong>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
    .split('\n\n').map(p => p.trim() ? `<p>${p.replace(/\n/g,'<br>')}</p>` : '').join('');
}

function showTyping() {
  const container = document.getElementById('messages');
  const wrap = document.createElement('div');
  wrap.className = 'bubble-wrap ai'; wrap.id = 'typing-indicator';
  wrap.innerHTML = `<div class="typing-bubble"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
  container.appendChild(wrap);
  scrollBottom();
}
function hideTyping() {
  const el = document.getElementById('typing-indicator');
  if (el) el.remove();
}

async function sendMessage() {
  const input = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');
  const text = input.value.trim();
  if (!text) return;

  input.value = ''; autoResize(input);
  appendBubble('user', text);
  sendBtn.disabled = true;
  showTyping();

  try {
    const r = await fetch(`${API}/chat`, {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify({ message: text })
    });
    hideTyping();
    if (r.status === 401) { signOut(); return; }
    const data = await r.json();
    const aiBubble = appendBubble('ai', data.response);
    if (data.sources && data.sources.length > 0) appendSources(aiBubble, data.sources);
  } catch(ex) {
    hideTyping();
    appendBubble('ai', 'âš ï¸ Connection error. Please check your internet and try again.');
  } finally {
    sendBtn.disabled = false;
    input.focus();
  }
}

function quickSend(text) {
  document.getElementById('user-input').value = text;
  sendMessage();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function scrollBottom() {
  const m = document.getElementById('messages');
  m.scrollTop = m.scrollHeight;
}

async function clearHistory() {
  if (!confirm('Clear all your chat history?')) return;
  try {
    const r = await fetch(`${API}/chat/history`, { method:'DELETE', headers: authHeaders() });
    if (r.ok) {
      document.getElementById('messages').innerHTML = `
        <div class="welcome-card">
          <div class="wc-icon">ğŸ“–</div>
          <h3>Fresh start!</h3>
          <p>Your chat history has been cleared. Ask me anything about SPLA031.</p>
        </div>`;
      showToast('Chat history cleared');
    }
  } catch(e) {}
}

// â”€â”€ Auto-login if token exists â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  if (!accessToken) return;
  try {
    const r = await fetch(`${API}/auth/me`, { headers: authHeaders() });
    if (r.ok) { currentUser = await r.json(); showChat(); }
    else { localStorage.removeItem('srh_token'); accessToken = null; }
  } catch(e) {}
})();
</script>
</body>
</html>