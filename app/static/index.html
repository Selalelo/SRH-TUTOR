<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>SPLA Tutor</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
  :root {
    --srh:       #c0394b;
    --srh-lt:    #e8536a;
    --srh-dk:    #8f1f2e;
    --cdl:       #1a6b5c;
    --cdl-lt:    #2a9d84;
    --cdl-dk:    #0f4a3f;
    --cream:     #f8f5f0;
    --sand:      #ede8e0;
    --sand-dk:   #cdc4b8;
    --ink:       #1c1714;
    --ink-lt:    #4a3f38;
    --muted:     #8a7e76;
    --white:     #ffffff;
    --radius:    16px;
    --shadow:    0 8px 32px rgba(28,23,20,0.12);

    /* Active module colours â€” defaults to SRH */
    --mod:       var(--srh);
    --mod-lt:    var(--srh-lt);
    --mod-dk:    var(--srh-dk);
  }

  body.cdl-mode {
    --mod:    var(--cdl);
    --mod-lt: var(--cdl-lt);
    --mod-dk: var(--cdl-dk);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Outfit', sans-serif;
    background: var(--cream);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
    transition: background 0.3s;
  }

  body::before {
    content: '';
    position: fixed; inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 15% -5%,  rgba(192,57,75,0.07)  0%, transparent 55%),
      radial-gradient(ellipse 60% 40% at 90% 100%, rgba(26,107,92,0.06)  0%, transparent 55%);
    pointer-events: none; z-index: 0;
    transition: all 0.4s;
  }
  body.cdl-mode::before {
    background:
      radial-gradient(ellipse 80% 50% at 15% -5%,  rgba(26,107,92,0.08)  0%, transparent 55%),
      radial-gradient(ellipse 60% 40% at 90% 100%, rgba(42,157,132,0.06) 0%, transparent 55%);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #auth-screen {
    position: relative; z-index: 1;
    min-height: 100vh;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 24px 20px;
  }

  .brand { text-align: center; margin-bottom: 32px; }
  .brand-icon {
    width: 68px; height: 68px;
    background: linear-gradient(135deg, var(--srh-lt), var(--srh-dk));
    border-radius: 22px;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 14px;
    box-shadow: 0 12px 28px rgba(192,57,75,0.32);
    font-size: 30px;
  }
  .brand h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.9rem; color: var(--ink);
    letter-spacing: -0.3px;
  }
  .brand p { font-size: 0.83rem; color: var(--muted); font-weight: 300; margin-top: 4px; }

  .auth-card {
    background: var(--white);
    border-radius: var(--radius);
    padding: 32px 28px;
    width: 100%; max-width: 420px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(192,57,75,0.08);
  }

  .tab-switcher {
    display: flex; gap: 4px;
    background: var(--sand);
    border-radius: 12px; padding: 4px;
    margin-bottom: 28px;
  }
  .tab-btn {
    flex: 1; padding: 10px;
    border: none; background: transparent;
    border-radius: 9px; cursor: pointer;
    font-family: 'Outfit', sans-serif;
    font-size: 0.875rem; font-weight: 500;
    color: var(--muted); transition: all 0.2s;
  }
  .tab-btn.active {
    background: var(--white);
    color: var(--srh);
    box-shadow: 0 2px 8px rgba(28,23,20,0.1);
  }

  .auth-form { display: flex; flex-direction: column; gap: 16px; }
  .auth-form.hidden { display: none; }

  .field { display: flex; flex-direction: column; gap: 6px; }
  .field label {
    font-size: 0.78rem; font-weight: 600;
    color: var(--ink-lt); letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .field input {
    padding: 13px 16px;
    border: 1.5px solid var(--sand-dk);
    border-radius: 10px;
    font-family: 'Outfit', sans-serif;
    font-size: 0.95rem; color: var(--ink);
    background: var(--cream);
    outline: none; transition: border-color 0.2s;
    -webkit-appearance: none;
  }
  .field input:focus { border-color: var(--srh); background: var(--white); }
  .field input::placeholder { color: var(--sand-dk); }

  .btn-primary {
    padding: 15px;
    background: linear-gradient(135deg, var(--srh-lt), var(--srh-dk));
    color: var(--white);
    border: none; border-radius: 12px;
    font-family: 'Outfit', sans-serif;
    font-size: 1rem; font-weight: 600;
    cursor: pointer; margin-top: 4px;
    box-shadow: 0 6px 20px rgba(192,57,75,0.28);
    transition: all 0.2s;
  }
  .btn-primary:hover { transform: translateY(-1px); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

  .auth-error {
    background: #fef0f0; border: 1px solid #fca5a5;
    color: #b91c1c; border-radius: 10px;
    padding: 12px 14px; font-size: 0.875rem; display: none;
  }
  .auth-success {
    background: #f0fdf4; border: 1px solid #86efac;
    color: #166534; border-radius: 10px;
    padding: 12px 14px; font-size: 0.875rem; display: none;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODULE SELECTOR
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .module-selector {
    display: flex; gap: 10px;
    padding: 12px 16px;
    background: var(--white);
    border-bottom: 1px solid var(--sand);
    overflow-x: auto;
  }
  .module-selector::-webkit-scrollbar { display: none; }

  .mod-pill {
    display: flex; align-items: center; gap: 7px;
    padding: 8px 16px;
    border-radius: 100px;
    border: 2px solid var(--sand-dk);
    background: var(--cream);
    cursor: pointer;
    font-family: 'Outfit', sans-serif;
    font-size: 0.8rem; font-weight: 600;
    color: var(--muted);
    white-space: nowrap;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .mod-pill.active-srh {
    background: linear-gradient(135deg, var(--srh-lt), var(--srh-dk));
    border-color: transparent; color: white;
    box-shadow: 0 4px 14px rgba(192,57,75,0.3);
  }
  .mod-pill.active-cdl {
    background: linear-gradient(135deg, var(--cdl-lt), var(--cdl-dk));
    border-color: transparent; color: white;
    box-shadow: 0 4px 14px rgba(26,107,92,0.3);
  }
  .mod-pill span.dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: currentColor; opacity: 0.7;
    display: inline-block;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHAT SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #chat-screen {
    display: none; flex-direction: column;
    height: 100vh; position: relative; z-index: 1;
  }

  .topbar {
    background: var(--white);
    border-bottom: 1px solid var(--sand);
    padding: 12px 20px;
    display: flex; align-items: center; gap: 12px;
    position: sticky; top: 0; z-index: 10;
    box-shadow: 0 2px 12px rgba(28,23,20,0.06);
  }
  .topbar-icon {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--mod-lt), var(--mod-dk));
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
    transition: background 0.3s;
  }
  .topbar-info { flex: 1; min-width: 0; }
  .topbar-info h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1rem; color: var(--ink);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .topbar-info span { font-size: 0.73rem; color: var(--muted); font-weight: 400; }
  .topbar-actions { display: flex; gap: 8px; }
  .icon-btn {
    width: 36px; height: 36px;
    border: 1.5px solid var(--sand-dk);
    background: var(--cream);
    border-radius: 10px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 15px; color: var(--muted);
    transition: all 0.18s;
  }
  .icon-btn:hover { border-color: var(--mod); color: var(--mod); background: var(--white); }

  /* Messages */
  #messages {
    flex: 1; overflow-y: auto;
    padding: 20px 16px;
    display: flex; flex-direction: column; gap: 16px;
    scroll-behavior: smooth;
  }

  /* Quick commands */
  .quick-commands {
    display: flex; gap: 8px; flex-wrap: nowrap;
    padding: 0 16px 10px;
    overflow-x: auto;
  }
  .quick-commands::-webkit-scrollbar { display: none; }
  .quick-cmd {
    padding: 7px 14px;
    background: var(--white);
    border: 1.5px solid var(--sand-dk);
    border-radius: 20px; cursor: pointer;
    font-family: 'Outfit', sans-serif;
    font-size: 0.78rem; font-weight: 500; color: var(--ink-lt);
    transition: all 0.18s; white-space: nowrap; flex-shrink: 0;
  }
  .quick-cmd:hover { border-color: var(--mod); color: var(--mod); background: var(--white); }
  .quick-cmd.cdl { border-color: rgba(26,107,92,0.3); color: var(--cdl-dk); }
  .quick-cmd.cdl:hover { border-color: var(--cdl); background: #f0faf8; }

  /* Bubbles */
  .bubble-wrap { display: flex; flex-direction: column; max-width: 84%; }
  .bubble-wrap.user { align-self: flex-end; align-items: flex-end; }
  .bubble-wrap.ai   { align-self: flex-start; align-items: flex-start; }

  .bubble {
    padding: 13px 16px;
    border-radius: 18px;
    font-size: 0.91rem; line-height: 1.65;
    word-break: break-word;
  }
  .bubble-wrap.user .bubble {
    background: linear-gradient(135deg, var(--mod-lt), var(--mod-dk));
    color: var(--white);
    border-bottom-right-radius: 4px;
    transition: background 0.3s;
  }
  .bubble-wrap.ai .bubble {
    background: var(--white);
    color: var(--ink);
    border: 1px solid var(--sand);
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 8px rgba(28,23,20,0.06);
  }
  .bubble-wrap.ai .bubble p { margin-bottom: 8px; }
  .bubble-wrap.ai .bubble p:last-child { margin-bottom: 0; }
  .bubble-wrap.ai .bubble strong { color: var(--mod-dk); }
  .bubble-wrap.ai .bubble code {
    background: var(--sand); padding: 2px 6px;
    border-radius: 5px; font-size: 0.85em;
  }
  .bubble-wrap.ai .bubble ul, .bubble-wrap.ai .bubble ol { padding-left: 18px; margin: 6px 0; }
  .bubble-wrap.ai .bubble li { margin-bottom: 4px; }

  .sources-tag {
    display: inline-flex; align-items: center; gap: 4px;
    background: #fff5f6; border: 1px solid rgba(192,57,75,0.2);
    color: var(--srh-dk);
    font-size: 0.71rem; font-weight: 500;
    padding: 3px 10px; border-radius: 20px;
    margin-top: 6px;
  }
  body.cdl-mode .sources-tag {
    background: #f0faf8; border-color: rgba(26,107,92,0.2);
    color: var(--cdl-dk);
  }

  /* Typing */
  .typing-bubble {
    background: var(--white);
    border: 1px solid var(--sand);
    border-radius: 18px; border-bottom-left-radius: 4px;
    padding: 14px 18px; display: flex; gap: 5px;
    box-shadow: 0 2px 8px rgba(28,23,20,0.06);
  }
  .dot {
    width: 7px; height: 7px;
    background: var(--sand-dk); border-radius: 50%;
    animation: bounce 1.2s infinite;
  }
  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-6px); background: var(--mod); }
  }

  /* Input */
  .input-area {
    padding: 10px 16px 18px;
    background: var(--white);
    border-top: 1px solid var(--sand);
  }
  .input-row { display: flex; gap: 10px; align-items: flex-end; }
  #user-input {
    flex: 1; padding: 13px 16px;
    border: 1.5px solid var(--sand-dk);
    border-radius: 14px;
    font-family: 'Outfit', sans-serif;
    font-size: 0.95rem; color: var(--ink);
    background: var(--cream);
    outline: none; resize: none;
    max-height: 120px; min-height: 50px;
    transition: border-color 0.2s;
    -webkit-appearance: none;
  }
  #user-input:focus { border-color: var(--mod); background: var(--white); }
  #user-input::placeholder { color: var(--sand-dk); }

  .send-btn {
    width: 50px; height: 50px; flex-shrink: 0;
    background: linear-gradient(135deg, var(--mod-lt), var(--mod-dk));
    border: none; border-radius: 14px;
    color: var(--white); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 14px rgba(28,23,20,0.2);
    transition: all 0.2s;
  }
  .send-btn:hover { transform: scale(1.05); }
  .send-btn:active { transform: scale(0.97); }
  .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .send-btn svg { width: 20px; height: 20px; }

  /* Welcome card */
  .welcome-card {
    background: var(--white);
    border: 1px solid var(--sand);
    border-radius: var(--radius);
    padding: 24px; text-align: center;
    box-shadow: 0 4px 16px rgba(28,23,20,0.06);
    align-self: center; width: 100%;
    animation: fadeUp 0.4s ease both;
  }
  .welcome-card .wc-icon { font-size: 2.5rem; margin-bottom: 12px; }
  .welcome-card h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem; color: var(--ink); margin-bottom: 8px;
  }
  .welcome-card p { font-size: 0.86rem; color: var(--muted); line-height: 1.6; }

  /* Module badge in welcome */
  .module-badge {
    display: inline-block;
    padding: 4px 12px; border-radius: 100px;
    font-size: 0.75rem; font-weight: 600;
    margin-bottom: 12px;
  }
  .module-badge.srh { background: #fff0f2; color: var(--srh-dk); border: 1px solid rgba(192,57,75,0.2); }
  .module-badge.cdl { background: #f0faf8; color: var(--cdl-dk); border: 1px solid rgba(26,107,92,0.2); }

  /* Animations */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .bubble-wrap { animation: fadeUp 0.28s ease both; }

  /* Toast */
  .toast {
    position: fixed; bottom: 90px; left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--ink); color: var(--white);
    padding: 10px 20px; border-radius: 100px;
    font-size: 0.84rem; opacity: 0;
    transition: all 0.3s; z-index: 999;
    white-space: nowrap;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Scrollbar */
  #messages::-webkit-scrollbar { width: 4px; }
  #messages::-webkit-scrollbar-track { background: transparent; }
  #messages::-webkit-scrollbar-thumb { background: var(--sand-dk); border-radius: 4px; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MEDIA QUERIES
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* â”€â”€ Small phones (< 360px) â”€â”€ */
  @media (max-width: 359px) {
    .brand h1        { font-size: 1.6rem; }
    .auth-card       { padding: 24px 18px; }
    .bubble-wrap     { max-width: 94%; }
    .mod-pill        { font-size: 0.72rem; padding: 6px 12px; }
    .topbar-info h2  { font-size: 0.9rem; }
    .input-area      { padding: 8px 12px 14px; }
    #user-input      { padding: 11px 13px; font-size: 0.88rem; }
    .send-btn        { width: 44px; height: 44px; }
    #messages        { padding: 14px 12px; }
    .quick-cmd       { font-size: 0.72rem; padding: 6px 11px; }
    .welcome-card    { padding: 18px 16px; }
    .welcome-card h3 { font-size: 1.05rem; }
  }

  /* â”€â”€ Standard phones (360px â€“ 480px) â”€â”€ */
  @media (min-width: 360px) and (max-width: 480px) {
    .brand h1        { font-size: 1.75rem; }
    .auth-card       { padding: 28px 22px; }
    .bubble-wrap     { max-width: 90%; }
    #messages        { padding: 16px 14px; }
    .input-area      { padding: 10px 14px 16px; }
    .welcome-card    { padding: 20px 18px; }
  }

  /* â”€â”€ Large phones / small tablets (481px â€“ 640px) â”€â”€ */
  @media (min-width: 481px) and (max-width: 640px) {
    .auth-card    { padding: 32px 28px; }
    .bubble-wrap  { max-width: 86%; }
    #messages     { padding: 18px 16px; }
  }

  /* â”€â”€ Tablets (641px â€“ 1023px) â”€â”€ */
  @media (min-width: 641px) and (max-width: 1023px) {
    /* Auth screen â€” centre card with more breathing room */
    #auth-screen  { padding: 40px 32px; }
    .auth-card    { max-width: 460px; padding: 40px 36px; }
    .brand h1     { font-size: 2.2rem; }
    .brand-icon   { width: 76px; height: 76px; font-size: 34px; }

    /* Chat â€” slightly wider bubbles area */
    #chat-screen  { max-width: 720px; margin: 0 auto; }
    .bubble-wrap  { max-width: 78%; }
    #messages     { padding: 24px 24px; }

    /* Module pills â€” show full text comfortably */
    .module-selector { padding: 14px 24px; gap: 12px; }
    .mod-pill        { font-size: 0.85rem; padding: 9px 20px; }

    /* Topbar */
    .topbar       { padding: 14px 24px; }
    .topbar-info h2 { font-size: 1.1rem; }

    /* Input */
    .input-area   { padding: 12px 24px 22px; }
    #user-input   { font-size: 1rem; }

    /* Quick commands */
    .quick-commands { padding: 0 24px 12px; gap: 10px; flex-wrap: wrap; }
    .quick-cmd      { font-size: 0.83rem; }

    /* Welcome card */
    .welcome-card   { max-width: 500px; padding: 32px 28px; }
    .welcome-card h3 { font-size: 1.35rem; }
  }

  /* â”€â”€ Desktop (â‰¥ 1024px) â”€â”€ */
  @media (min-width: 1024px) {
    /* Auth â€” larger, more spaced */
    #auth-screen  { padding: 60px 40px; }
    .auth-card    { max-width: 480px; padding: 44px 40px; }
    .brand h1     { font-size: 2.4rem; }
    .brand-icon   { width: 80px; height: 80px; font-size: 36px; }
    .brand        { margin-bottom: 40px; }

    /* Chat â€” constrain to readable width, centred */
    #chat-screen  { max-width: 820px; margin: 0 auto;
                    box-shadow: 0 0 60px rgba(28,23,20,0.1); }

    .bubble-wrap  { max-width: 72%; }
    #messages     { padding: 28px 32px; gap: 20px; }

    /* Module pills */
    .module-selector { padding: 16px 32px; gap: 14px; }
    .mod-pill        { font-size: 0.88rem; padding: 10px 22px; }

    /* Topbar */
    .topbar         { padding: 16px 32px; }
    .topbar-info h2 { font-size: 1.15rem; }
    .topbar-icon    { width: 44px; height: 44px; font-size: 20px; }

    /* Input */
    .input-area     { padding: 14px 32px 24px; }
    #user-input     { font-size: 1rem; border-radius: 16px; }
    .send-btn       { width: 54px; height: 54px; border-radius: 16px; }

    /* Quick commands wrap on desktop */
    .quick-commands { padding: 0 32px 14px; gap: 10px; flex-wrap: wrap; }
    .quick-cmd      { font-size: 0.85rem; padding: 8px 16px; }

    /* Welcome */
    .welcome-card   { max-width: 560px; padding: 36px 32px; }
    .welcome-card h3 { font-size: 1.45rem; }
    .welcome-card p  { font-size: 0.92rem; }

    /* Hover effects only on desktop (no hover flicker on touch) */
    .btn-primary:hover  { box-shadow: 0 10px 28px rgba(192,57,75,0.38); }
    .mod-pill:hover:not(.active-srh):not(.active-cdl) {
      border-color: var(--mod); color: var(--mod-dk); background: var(--white);
    }
  }

  /* â”€â”€ Wide desktop (â‰¥ 1280px) â”€â”€ */
  @media (min-width: 1280px) {
    #chat-screen  { max-width: 900px; }
    #messages     { padding: 32px 40px; }
    .topbar       { padding: 18px 40px; }
    .input-area   { padding: 16px 40px 28px; }
    .quick-commands { padding: 0 40px 14px; }
    .module-selector { padding: 16px 40px; }
  }

  /* â”€â”€ Touch device: remove hover transforms to prevent sticky states â”€â”€ */
  @media (hover: none) {
    .btn-primary:hover  { transform: none; box-shadow: 0 6px 20px rgba(192,57,75,0.28); }
    .send-btn:hover     { transform: none; }
    .icon-btn:hover     { border-color: var(--sand-dk); color: var(--muted); background: var(--cream); }
    .quick-cmd:hover    { border-color: var(--sand-dk); color: var(--ink-lt); background: var(--white); }
    .mod-pill:hover     { border-color: var(--sand-dk); color: var(--muted); background: var(--cream); }
  }

  /* â”€â”€ Reduced motion â”€â”€ */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
  }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="brand">
    <div class="brand-icon">ğŸ¥</div>
    <h1>SPLA Tutor</h1>
    <p>Sexual &amp; Reproductive Health Â· Chronic Disease &amp; Lifestyle</p>
  </div>

  <div class="auth-card">
    <div class="tab-switcher">
      <button class="tab-btn active" onclick="switchTab('signin')">Sign In</button>
      <button class="tab-btn"        onclick="switchTab('signup')">Sign Up</button>
    </div>

    <!-- Sign In -->
    <form class="auth-form" id="signin-form" onsubmit="handleSignIn(event)">
      <div class="auth-error"   id="signin-error"></div>
      <div class="auth-success" id="signin-success"></div>
      <div class="field">
        <label>Email</label>
        <input type="email" id="signin-email" placeholder="your@email.com" required/>
      </div>
      <div class="field">
        <label>Password</label>
        <input type="password" id="signin-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required/>
      </div>
      <button type="submit" class="btn-primary" id="signin-btn">Sign In</button>
      <p style="text-align:center;margin-top:8px;font-size:0.81rem;color:var(--muted);">
        Didn't get a confirmation email?
        <a href="#" onclick="showResend()" style="color:var(--srh);font-weight:600;text-decoration:none;">Resend it</a>
      </p>
    </form>

    <!-- Resend -->
    <div id="resend-panel" class="auth-form hidden" style="gap:14px;">
      <div class="auth-error"   id="resend-error"></div>
      <div class="auth-success" id="resend-success"></div>
      <p style="font-size:0.875rem;color:var(--muted);text-align:center;line-height:1.5;">Enter your email and we'll send a fresh confirmation link.</p>
      <div class="field">
        <label>Email</label>
        <input type="email" id="resend-email" placeholder="your@email.com" required/>
      </div>
      <button class="btn-primary" id="resend-btn" onclick="handleResend()">Send Confirmation Email</button>
      <p style="text-align:center;font-size:0.81rem;color:var(--muted);">
        <a href="#" onclick="showSignIn()" style="color:var(--srh);font-weight:600;text-decoration:none;">â† Back to Sign In</a>
      </p>
    </div>

    <!-- Sign Up -->
    <form class="auth-form hidden" id="signup-form" onsubmit="handleSignUp(event)">
      <div class="auth-error"   id="signup-error"></div>
      <div class="auth-success" id="signup-success"></div>
      <div class="field">
        <label>Full Name</label>
        <input type="text" id="signup-name" placeholder="Jane Doe" required/>
      </div>
      <div class="field">
        <label>Email</label>
        <input type="email" id="signup-email" placeholder="your@email.com" required/>
      </div>
      <div class="field">
        <label>Password</label>
        <input type="password" id="signup-password" placeholder="Min. 6 characters" minlength="6" required/>
      </div>
      <button type="submit" class="btn-primary" id="signup-btn">Create Account</button>
    </form>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHAT â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="chat-screen">

  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar-icon" id="topbar-icon">ğŸ¥</div>
    <div class="topbar-info">
      <h2 id="topbar-title">SPLA Tutor</h2>
      <span id="user-label">Loadingâ€¦</span>
    </div>
    <div class="topbar-actions">
      <button class="icon-btn" onclick="clearHistory()" title="Clear chat">ğŸ—‘ï¸</button>
      <button class="icon-btn" onclick="signOut()" title="Sign out">ğŸšª</button>
    </div>
  </div>

  <!-- Module selector -->
  <div class="module-selector">
    <button class="mod-pill active-srh" id="pill-srh" onclick="switchModule('srh')">
      <span class="dot"></span> SPLA031 Â· Sexual &amp; Reproductive Health
    </button>
    <button class="mod-pill" id="pill-cdl" onclick="switchModule('cdl')">
      <span class="dot"></span> Chronic Disease &amp; Lifestyle
    </button>
  </div>

  <!-- Messages -->
  <div id="messages">
    <div class="welcome-card" id="welcome-card">
      <div class="wc-icon">ğŸ“–</div>
      <div class="module-badge srh" id="welcome-badge">SPLA031 Â· SRH</div>
      <h3 id="welcome-title">Sexual &amp; Reproductive Health</h3>
      <p id="welcome-text">Ask me anything from your SRH training manual â€” anatomy, contraception, STIs, pregnancy, and more.</p>
    </div>
  </div>

  <!-- Quick commands (dynamically updated per module) -->
  <div class="quick-commands" id="quick-commands">
    <!-- injected by JS -->
  </div>

  <!-- Input -->
  <div class="input-area">
    <div class="input-row">
      <textarea id="user-input" placeholder="Ask about SRH topicsâ€¦" rows="1"
        onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <button class="send-btn" id="send-btn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = 'https://srh-tutor-1.onrender.com';
let accessToken = localStorage.getItem('srh_token') || null;
let currentUser = null;
let activeModule = localStorage.getItem('spla_module') || 'srh';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODULE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODULES = {
  srh: {
    icon:        'ğŸ¥',
    title:       'Sexual & Reproductive Health',
    badge:       'SPLA031 Â· SRH',
    badgeClass:  'srh',
    placeholder: 'Ask about SRH topicsâ€¦',
    welcome:     'Ask me anything from your SRH training manual â€” anatomy, contraception, STIs, pregnancy, and more.',
    commands: [
      { label: 'ğŸ”¬ Menstrual cycle',    text: 'Explain the menstrual cycle' },
      { label: 'ğŸ’Š Contraception',      text: 'What are the types of contraception?' },
      { label: 'ğŸ§¬ HIV transmission',   text: 'Explain HIV transmission and prevention' },
      { label: 'ğŸ¤° Antenatal care',     text: 'What happens during antenatal care?' },
      { label: 'â“ Quiz me',            text: 'Quiz me on SRH topics' },
      { label: 'ğŸ“ Case study',         text: 'Give me a case study exercise on reproductive health' },
    ]
  },
  cdl: {
    icon:        'ğŸ«€',
    title:       'Chronic Disease & Lifestyle',
    badge:       'CDL Â· Lifestyle',
    badgeClass:  'cdl',
    placeholder: 'Ask about chronic disease & lifestyle topicsâ€¦',
    welcome:     'Ask me anything from your Chronic Disease & Lifestyle training material â€” hypertension, diabetes, obesity, nutrition, and more.',
    commands: [
      { label: 'â¤ï¸ Hypertension',       text: 'Explain hypertension causes and management' },
      { label: 'ğŸ©¸ Diabetes',           text: 'What is type 2 diabetes and how is it managed?' },
      { label: 'ğŸ Nutrition',          text: 'Explain the role of nutrition in chronic disease prevention' },
      { label: 'ğŸƒ Physical activity',  text: 'How does physical activity affect chronic disease risk?' },
      { label: 'ğŸ« Respiratory disease', text: 'Explain chronic obstructive pulmonary disease (COPD)' },
      { label: 'â“ Quiz me',            text: 'Quiz me on chronic disease and lifestyle topics' },
    ]
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODULE SWITCHER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Per-module chat cache (in memory) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const moduleChats = { srh: null, cdl: null };

function saveChatState(mod) {
  // Save current messages HTML for this module
  moduleChats[mod] = document.getElementById('messages').innerHTML;
}

function restoreChatState(mod) {
  const container = document.getElementById('messages');
  if (moduleChats[mod]) {
    container.innerHTML = moduleChats[mod];
    scrollBottom();
  } else {
    resetMessages(mod);
  }
}

function switchModule(mod) {
  if (mod === activeModule) return;

  // Save current module's chat before switching
  saveChatState(activeModule);

  activeModule = mod;
  localStorage.setItem('spla_module', mod);
  const cfg = MODULES[mod];

  // Body class for colour scheme
  document.body.classList.toggle('cdl-mode', mod === 'cdl');

  // Pills
  document.getElementById('pill-srh').className = 'mod-pill' + (mod === 'srh' ? ' active-srh' : '');
  document.getElementById('pill-cdl').className = 'mod-pill' + (mod === 'cdl' ? ' active-cdl' : '');

  // Topbar
  document.getElementById('topbar-icon').textContent  = cfg.icon;
  document.getElementById('topbar-title').textContent = cfg.title;

  // Input placeholder
  document.getElementById('user-input').placeholder = cfg.placeholder;

  // Quick commands
  renderQuickCommands(mod);

  // Restore this module's chat (or show welcome if first visit)
  restoreChatState(mod);

  showToast(`Switched to ${cfg.title}`);
}

function renderQuickCommands(mod) {
  const container = document.getElementById('quick-commands');
  container.innerHTML = '';
  MODULES[mod].commands.forEach(cmd => {
    const btn = document.createElement('button');
    btn.className = `quick-cmd${mod === 'cdl' ? ' cdl' : ''}`;
    btn.textContent = cmd.label;
    btn.onclick = () => quickSend(cmd.text);
    container.appendChild(btn);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResend() {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('signin-form').classList.add('hidden');
  document.getElementById('signup-form').classList.add('hidden');
  document.getElementById('resend-panel').classList.remove('hidden');
}
function showSignIn() {
  document.getElementById('resend-panel').classList.add('hidden');
  switchTab('signin');
}

async function handleResend() {
  const btn = document.getElementById('resend-btn');
  const err = document.getElementById('resend-error');
  const suc = document.getElementById('resend-success');
  const email = document.getElementById('resend-email').value.trim();
  err.style.display = 'none'; suc.style.display = 'none';
  if (!email) { err.textContent = 'Please enter your email.'; err.style.display = 'block'; return; }
  btn.disabled = true; btn.textContent = 'Sendingâ€¦';
  try {
    const res = await fetch(`${API}/auth/resend-confirmation`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ email, password: '' })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || 'Failed');
    suc.textContent = data.message; suc.style.display = 'block';
    setTimeout(() => showSignIn(), 3000);
  } catch(ex) {
    err.textContent = ex.message; err.style.display = 'block';
  } finally {
    btn.disabled = false; btn.textContent = 'Send Confirmation Email';
  }
}

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach((b,i) =>
    b.classList.toggle('active', (tab==='signin'&&i===0)||(tab==='signup'&&i===1))
  );
  document.getElementById('signin-form').classList.toggle('hidden', tab !== 'signin');
  document.getElementById('signup-form').classList.toggle('hidden', tab !== 'signup');
  document.getElementById('resend-panel').classList.add('hidden');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function authHeaders() {
  return { 'Content-Type':'application/json', 'Authorization':`Bearer ${accessToken}` };
}

async function handleSignIn(e) {
  e.preventDefault();
  const btn = document.getElementById('signin-btn');
  const err = document.getElementById('signin-error');
  err.style.display = 'none';
  btn.disabled = true; btn.textContent = 'Signing inâ€¦';
  try {
    const res = await fetch(`${API}/auth/signin`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        email:    document.getElementById('signin-email').value,
        password: document.getElementById('signin-password').value
      })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || 'Sign in failed');
    accessToken  = data.access_token;
    currentUser  = data.user;
    localStorage.setItem('srh_token', accessToken);
    showChat();
  } catch(ex) {
    err.textContent = ex.message; err.style.display = 'block';
  } finally {
    btn.disabled = false; btn.textContent = 'Sign In';
  }
}

async function handleSignUp(e) {
  e.preventDefault();
  const btn = document.getElementById('signup-btn');
  const err = document.getElementById('signup-error');
  const suc = document.getElementById('signup-success');
  err.style.display = 'none'; suc.style.display = 'none';
  btn.disabled = true; btn.textContent = 'Creating accountâ€¦';
  try {
    const res = await fetch(`${API}/auth/signup`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        email:     document.getElementById('signup-email').value,
        password:  document.getElementById('signup-password').value,
        full_name: document.getElementById('signup-name').value
      })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || 'Sign up failed');
    suc.textContent = data.message || 'Account created! Please check your email.';
    suc.style.display = 'block';
    document.getElementById('signup-form').reset();
    setTimeout(() => switchTab('signin'), 2500);
  } catch(ex) {
    err.textContent = ex.message; err.style.display = 'block';
  } finally {
    btn.disabled = false; btn.textContent = 'Create Account';
  }
}

async function signOut() {
  try { await fetch(`${API}/auth/signout`, { method:'POST', headers: authHeaders() }); } catch(e) {}
  accessToken = null; currentUser = null;
  localStorage.removeItem('srh_token');
  document.getElementById('chat-screen').style.display  = 'none';
  document.getElementById('auth-screen').style.display  = 'flex';
  resetMessages();
  showToast('Signed out successfully');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function showChat() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('chat-screen').style.display = 'flex';
  try {
    if (!currentUser) {
      const r = await fetch(`${API}/auth/me`, { headers: authHeaders() });
      if (r.ok) currentUser = await r.json();
    }
    if (currentUser) {
      document.getElementById('user-label').textContent = currentUser.full_name || currentUser.email;
    }
    await loadHistory();
  } catch(e) {}
  // Apply saved module
  switchModule(activeModule);
  document.getElementById('user-input').focus();
}

async function loadHistory() {
  try {
    const r = await fetch(`${API}/chat/history`, { headers: authHeaders() });
    if (!r.ok) return;
    const history = await r.json();
    if (history.length === 0) return;
    const container = document.getElementById('messages');
    container.innerHTML = '';
    history.forEach(msg => appendBubble(msg.role === 'human' ? 'user' : 'ai', msg.content, false));
    scrollBottom();
    // Cache it for the current module
    moduleChats[activeModule] = container.innerHTML;
  } catch(e) {}
}

function appendBubble(role, text, scroll=true) {
  const container = document.getElementById('messages');
  const wrap   = document.createElement('div');
  wrap.className = `bubble-wrap ${role}`;
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerHTML = role === 'ai' ? formatMarkdown(text) : escapeHtml(text);
  wrap.appendChild(bubble);
  container.appendChild(wrap);
  if (scroll) scrollBottom();
  return wrap;
}

function appendSources(parentWrap, sources) {
  if (!sources || sources.length === 0) return;
  const tag = document.createElement('div');
  tag.className = 'sources-tag';
  tag.innerHTML = `ğŸ“„ ${sources.join(' Â· ')}`;
  parentWrap.appendChild(tag);
}

function escapeHtml(text) {
  return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function formatMarkdown(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code>$1</code>')
    .replace(/^### (.+)$/gm, '<strong>$1</strong>')
    .replace(/^## (.+)$/gm,  '<strong>$1</strong>')
    .replace(/^- (.+)$/gm,   '<li>$1</li>')
    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
    .split('\n\n').map(p => p.trim() ? `<p>${p.replace(/\n/g,'<br>')}</p>` : '').join('');
}

function showTyping() {
  const container = document.getElementById('messages');
  const wrap = document.createElement('div');
  wrap.className = 'bubble-wrap ai'; wrap.id = 'typing-indicator';
  wrap.innerHTML = `<div class="typing-bubble"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
  container.appendChild(wrap);
  scrollBottom();
}
function hideTyping() {
  const el = document.getElementById('typing-indicator');
  if (el) el.remove();
}

async function checkReady() {
  try {
    const r = await fetch(`${API}/ready`);
    const d = await r.json();
    return d.ready === true;
  } catch { return false; }
}

async function sendMessage() {
  const input   = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');
  const text    = input.value.trim();
  if (!text) return;

  input.value = ''; autoResize(input);
  appendBubble('user', text);
  sendBtn.disabled = true;
  showTyping();

  try {
    const ready = await checkReady();
    if (!ready) {
      hideTyping();
      appendBubble('ai', 'â³ The AI model is still warming up (~30 seconds on first start). Your message has been sent â€” please waitâ€¦');
      showTyping();
    }

    const r = await fetch(`${API}/chat`, {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify({ message: text })
    });
    hideTyping();
    if (r.status === 401) { signOut(); return; }
    if (!r.ok) {
      const err = await r.json();
      appendBubble('ai', `âš ï¸ ${err.detail || 'Something went wrong. Please try again.'}`);
      return;
    }
    const data = await r.json();
    const aiBubble = appendBubble('ai', data.response);
    if (data.sources?.length > 0) appendSources(aiBubble, data.sources);
  } catch(ex) {
    hideTyping();
    appendBubble('ai', 'âš ï¸ Connection error. Please check your internet and try again.');
  } finally {
    sendBtn.disabled = false;
    input.focus();
  }
}

function quickSend(text) {
  document.getElementById('user-input').value = text;
  sendMessage();
}
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}
function scrollBottom() {
  const m = document.getElementById('messages');
  m.scrollTop = m.scrollHeight;
}

function resetMessages(mod) {
  mod = mod || activeModule;
  const cfg = MODULES[mod];
  moduleChats[mod] = null;  // clear cache for this module
  document.getElementById('messages').innerHTML = `
    <div class="welcome-card" id="welcome-card">
      <div class="wc-icon">${cfg.icon}</div>
      <div class="module-badge ${cfg.badgeClass}" id="welcome-badge">${cfg.badge}</div>
      <h3 id="welcome-title">${cfg.title}</h3>
      <p id="welcome-text">${cfg.welcome}</p>
    </div>`;
}

async function clearHistory() {
  if (!confirm('Clear all chat history for the current module?')) return;
  try {
    const r = await fetch(`${API}/chat/history`, { method:'DELETE', headers: authHeaders() });
    if (r.ok) {
      resetMessages(activeModule);
      showToast('Chat history cleared');
    }
  } catch(e) {}
}

// â”€â”€ Init quick commands on load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderQuickCommands(activeModule);
if (activeModule === 'cdl') document.body.classList.add('cdl-mode');

// â”€â”€ Auto-login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  if (!accessToken) return;
  try {
    const r = await fetch(`${API}/auth/me`, { headers: authHeaders() });
    if (r.ok) { currentUser = await r.json(); showChat(); }
    else { localStorage.removeItem('srh_token'); accessToken = null; }
  } catch(e) {}
})();
</script>
</body>
</html>